<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>LawGic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" content="{{_csrf.token}}">
    <meta name="_csrf_header" content="{{_csrf.headerName}}">
    <style>
        .navbar {
            background-color: #2323dd;
            padding: 12px 24px;
            position: fixed; /* ìƒë‹¨ ê³ ì • */
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œ */
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f9fafb;
            padding-top: 70px; /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ë†’ì´ë§Œí¼ ì•„ë˜ë¡œ ë°€ê¸° */
        }

        .lgc-sec-title-link {
            color: inherit; /* ë¶€ëª¨ ê¸€ììƒ‰ ìƒì† */
            text-decoration: none; /* ë°‘ì¤„ ì œê±° */
        }

        .lgc-sec-title-link:hover {
            color: inherit; /* hover ì‹œ ìƒ‰ìƒ ìœ ì§€ */
            text-decoration: none;
        }

        .navbar-brand {
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .navbar-brand:hover {
            color: white;
        }

        .nav-link, .navbar-text {
            color: white !important;
        }

        .search-form input {
            width: 240px;
        }

        .hero {
            background-color: #f1f5f9;
            padding: 80px 20px;
            text-align: center;
        }

        .footer {
            background-color: #333;
            color: #fff;
            padding: 30px 0;
            text-align: center;
            margin-top: 60px;
        }

        .dashboard-links {
            padding: 40px 20px;
        }

        .dashboard-links h5 {
            font-weight: bold;
            margin-bottom: 15px;
        }

        .dashboard-links a {
            display: block;
            margin-bottom: 10px;
            color: #007bff;
            text-decoration: none;
        }
    </style>
</head>
<body>

<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <!-- ë¡œê³  + ê²€ìƒ‰ -->
        <div class="d-flex align-items-center">
            <a class="navbar-brand" href="/view">LAWGIC</a>
            <form class="d-flex search-form ms-3" method="get" action="/view/posts/search">
                <input class="form-control form-control-sm me-2" type="search" name="keyword" placeholder="ê²Œì‹œê¸€ ê²€ìƒ‰">
                <button class="btn btn-light btn-sm" type="submit">ê²€ìƒ‰</button>
            </form>
        </div>

        <!-- ë¡œê·¸ì¸ ìƒíƒœ -->
        <ul class="navbar-nav flex-row align-items-center gap-3">
            {{#userEmail}}
                <li class="nav-item"><a class="nav-link disabled">í™˜ì˜í•©ë‹ˆë‹¤, {{username}}ë‹˜</a></li>

                <li class="nav-item"><a class="nav-link" href="/view/posts/new">ê¸€ì“°ê¸°</a></li>

                {{#isAdmin}}
                    <li class="nav-item"><a class="nav-link" href="/admin">ê´€ë¦¬ì í˜ì´ì§€</a></li>
                {{/isAdmin}}
                {{^isAdmin}}
                    <li class="nav-item"><a class="nav-link" href="/view/mypage">ë§ˆì´í˜ì´ì§€</a></li>
                {{/isAdmin}}

                <li class="nav-item">
                    <form action="/logout" method="post" class="d-inline">
                        <input type="hidden" name="{{_csrf.parameterName}}" value="{{_csrf.token}}">
                        <button type="submit" class="btn btn-sm btn-outline-light ms-2">ë¡œê·¸ì•„ì›ƒ</button>
                    </form>
                </li>

                <!-- ğŸ”” ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì—ê²Œë§Œ ì•Œë¦¼ ë²¨ ë…¸ì¶œ -->
                <li class="nav-item dropdown" data-bs-auto-close="outside">
                    <button
                            class="nav-link dropdown-toggle position-relative btn btn-link p-0"
                            id="notifDropdown"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        <i class="fa-solid fa-bell text-light fs-5"></i>
                        <span id="notifCount"
                              class="badge rounded-pill bg-danger position-absolute top-0 start-100 translate-middle"
                              style="display:none;">0</span>
                    </button>

                    <ul class="dropdown-menu dropdown-menu-end p-0" aria-labelledby="notifDropdown"
                        style="min-width:320px;">
                        <li class="px-3 py-2 d-flex justify-content-between align-items-center">
                            <strong>ì•Œë¦¼</strong>
                            <button id="markAllReadBtn" class="btn btn-sm btn-link">ëª¨ë‘ ì½ìŒ</button>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <div id="notifList" style="max-height:360px; overflow:auto;">
                                <div class="text-center text-muted py-3">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
                            </div>
                        </li>
                    </ul>
                </li>
                <!-- /ì•Œë¦¼ ë²¨ -->
            {{/userEmail}}

            {{^userEmail}}
                <li class="nav-item">
                    <a class="nav-link" href="/view/login">ë¡œê·¸ì¸</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/view/signup?user=member">íšŒì›ê°€ì…</a>
                </li>
            {{/userEmail}}
        </ul>
    </div>
</nav>
{{#userEmail}}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
          const $ddToggle = document.getElementById('notifDropdown');
          const $count    = document.getElementById('notifCount');
          const $list     = document.getElementById('notifList');
          const $markAll  = document.getElementById('markAllReadBtn');
          if (!$ddToggle || !$count || !$list) return;

          // ë“œë¡­ë‹¤ìš´ ì¸ìŠ¤í„´ìŠ¤ ë³´ì¥
          bootstrap.Dropdown.getOrCreateInstance($ddToggle);

          // ---- helpers ----
          function csrfHeaders() {
            const token  = document.querySelector('meta[name="_csrf"]')?.content;
            const header = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
            return token ? { [header]: token } : {};
          }
          const isJson = (res) => (res.headers.get('content-type') || '').includes('application/json');

          // /view/post/123 ë˜ëŠ” /view/posts/123 ë¥¼ /view/posts/123 ë¡œ í‘œì¤€í™”í•˜ë˜, ê¸°ì¡´ ì¿¼ë¦¬/í•´ì‹œëŠ” ìœ ì§€
          function normalizeUrl(url) {
            try {
              const u = new URL(url, window.location.origin);
              const m = u.pathname.match(/\/view\/post[s]?\/(\d+)/);
              if (m) u.pathname = `/view/posts/${m[1]}`;
              return u.pathname + u.search + u.hash;
            } catch {
              const m = (url || '').match(/^(.*?)(\?[^#]*)?(#.*)?$/);
              const path = (m?.[1] ?? '');
              const q    = (m?.[2] ?? '');
              const h    = (m?.[3] ?? '');
              const idm  = path.match(/\/view\/post[s]?\/(\d+)/);
              const newPath = idm ? `/view/posts/${idm[1]}` : path || '#';
              return newPath + q + h;
            }
          }

          // url ì— ì•ˆì „í•˜ê²Œ ì¿¼ë¦¬ ì¶”ê°€
          function addQueryParam(url, key, value) {
            try {
              const u = new URL(url, window.location.origin);
              u.searchParams.set(key, value);
              return u.pathname + u.search + u.hash;
            } catch {
              const hasQ = url.includes('?');
              const sep  = hasQ ? '&' : '?';
              return `${url}${sep}${encodeURIComponent(key)}=${encodeURIComponent(value)}`;
            }
          }

            function getCookie(name) {
    return document.cookie
      .split('; ')
      .map(v => v.split('='))
      .reduce((acc,[k,...rest]) => (acc[k] = rest.join('='), acc), {})[name];
  }

  function csrfHeaders() {
    // 1) <meta> ìš°ì„ 
    const metaToken  = document.querySelector('meta[name="_csrf"]')?.content;
    const metaHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    if (metaToken && metaHeader) return { [metaHeader]: metaToken };

    // 2) Cookie(XSRF-TOKEN) í´ë°± (Spring Security CookieCsrfTokenRepository ì‚¬ìš© ì‹œ)
    const xsrf = getCookie('XSRF-TOKEN');
    if (xsrf) return { 'X-XSRF-TOKEN': decodeURIComponent(xsrf) };

    // 3) íˆë“  í•„ë“œ í´ë°± (í˜ì´ì§€ ì–´ë”˜ê°€ì— _csrf inputì´ ìˆì„ ë•Œ)
    const hidden = document.querySelector('input[name="_csrf"]');
    if (hidden?.value) return { 'X-CSRF-TOKEN': hidden.value };

    // ì‹¤íŒ¨ ì‹œ ë¹ˆ í—¤ë” ë°˜í™˜í•˜ì§€ ë§ê³  ì½˜ì†” ê²½ê³ 
    console.warn('CSRF í† í°ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. PATCH/POSTê°€ 403 ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return {};
  }

          function setBadge(n) {
            const v = Math.max(0, Number(n || 0));
            if (v > 0) { $count.textContent = v; $count.style.display = 'inline-block'; }
            else { $count.textContent = 0; $count.style.display = 'none'; }
          }
          function decBadge() {
            setBadge((Number($count.textContent) || 0) - 1);
          }
          function markUIRead(aEl) {
            aEl.classList.remove('fw-bold');
            const dot = aEl.querySelector('div.me-2');
            if (dot) dot.style.background = 'transparent';
          }
          function ensureEmptyMessage() {
            const anyItem = $list.querySelector('a.dropdown-item');
            const anyBold = $list.querySelector('a.dropdown-item.fw-bold');
            if (!anyItem) {
              $list.innerHTML = '<div class="text-center text-muted py-3">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else if (!anyBold && (Number($count.textContent) || 0) === 0) {
              // ëª¨ë‘ ì½ìŒ ìƒíƒœ: ëª©ë¡ì€ ë‚¨ê²¨ë‘ë˜ ë°°ì§€ë§Œ 0
            }
          }

          // ---- API ----
          async function fetchUnreadCount() {
            try {
            const res = await fetch(`/api/notifications/unread-count?ts=${Date.now()}`, {
            credentials: 'same-origin',
            cache: 'no-store',
            headers: { 'Accept': 'application/json' }
            });
            if (!res.ok) return; // ì„œë²„ ê°’ë§Œ ì‹ ë¢°
            const { count } = await res.json();
            setBadge(count ?? 0);
            } catch (_) {}
          }


async function fetchList() {
  try {
    const res = await fetch(`/api/notifications?limit=10&ts=${Date.now()}`, {
      credentials: 'same-origin',
      cache: 'no-store',
      headers: { 'Accept': 'application/json' }
    });
    if (!res.ok) {
      $list.innerHTML = '<div class="text-center text-muted py-3">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
      return;
    }
    const text  = await res.text();
    const items = (text && text.trim().startsWith('[')) ? JSON.parse(text) : [];

              if (!items.length) {
                $list.innerHTML = '<div class="text-center text-muted py-3">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
              }

              $list.innerHTML = items.map(i => {
                // í‘œì¤€í™” â†’ nid ì¿¼ë¦¬ ì¶”ê°€
                const hrefBase = normalizeUrl(i.linkUrl);
                const href     = addQueryParam(hrefBase, 'nid', i.id);

                const d = new Date(i.createdAt);
                const when = isNaN(d) ? (i.createdAt ?? '') : d.toLocaleString();

                return `
                  <a class="dropdown-item d-flex ${i.read ? '' : 'fw-bold'}" href="${href}" data-id="${i.id}">
                    <div class="me-2" style="width:6px; border-radius:3px; background:${i.read ? 'transparent' : '#dc3545'}"></div>
                    <div>
                      <div>${i.message ?? ''}</div>
                      <div class="small text-muted">${when}</div>
                    </div>
                  </a>
                `;
              }).join('');
            } catch (e) {
    $list.innerHTML = '<div class="text-center text-muted py-3">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
  }
          }

          // ë“œë¡­ë‹¤ìš´ ì—´ë¦´ ë•Œ ëª©ë¡ ê°±ì‹ 
          $ddToggle.addEventListener('show.bs.dropdown', fetchList);

          // í•­ëª© í´ë¦­ â†’ (1)UI ì¦‰ì‹œ ì½ìŒ (2)ì„œë²„ PATCH(keepalive) (3)ë‹«ê³  ì´ë™
          $list.addEventListener('click', async (ev) => {
            const a = ev.target.closest('a.dropdown-item');
            if (!a) return;
            ev.preventDefault();

            const id   = a.getAttribute('data-id');
            const href = a.getAttribute('href'); // ì´ë¯¸ normalize + ?nid= ì ìš©ë¨

            // (1) UI ë¨¼ì € ë°˜ì˜
            if (a.classList.contains('fw-bold')) {
              markUIRead(a);
              decBadge();
            }

            // (2) ì„œë²„ ì½ìŒ ì²˜ë¦¬
            try {
              await fetch(`/api/notifications/${id}/read`, {
                method: 'PATCH',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                keepalive: true
              });
            } catch (_) {}

            // (3) ë‹«ê³  ì´ë™
            try { bootstrap.Dropdown.getOrCreateInstance($ddToggle).hide(); } catch (_) {}
            ensureEmptyMessage();

            if (href && href !== '#') window.location.assign(href);
          });

          // ëª¨ë‘ ì½ìŒ
          $markAll?.addEventListener('click', async (e) => {
  e.preventDefault();
  e.stopPropagation();
  try {
    const res = await fetch('/api/notifications/read-all', {
      method: 'PATCH',
      credentials: 'same-origin',
      cache: 'no-store',
      headers: { 'Content-Type': 'application/json', ...csrfHeaders(), 'Accept': 'application/json' },
      keepalive: true
    });

    if (!res.ok) {
      console.error('ëª¨ë‘ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨', res.status, await res.text());
      // ì„œë²„ ë°˜ì˜ ì‹¤íŒ¨ â†’ ì¦‰ì‹œ ì„œë²„ ê°’ ì¬ë™ê¸°í™”(ë°°ì§€ ë³µêµ¬)
      await fetchUnreadCount();
      return;
    }

    // ì„±ê³µ ì‹œ UI ì¼ê´„ ê°±ì‹ 
    $list.querySelectorAll('a.dropdown-item.fw-bold').forEach(markUIRead);
    setBadge(0);
    ensureEmptyMessage();

  } catch (err) {
    console.error('ëª¨ë‘ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨', err);
    await fetchUnreadCount();
  }
});


          // ìµœì´ˆ ë°°ì§€ ë™ê¸°í™” + ì£¼ê¸° ê°±ì‹ 
          fetchUnreadCount();
          setInterval(fetchUnreadCount, 30000);
        });
    </script>
{{/userEmail}}